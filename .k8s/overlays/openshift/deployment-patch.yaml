apiVersion: apps/v1
kind: Deployment
metadata:
  name: sb-demo
  annotations:
    image.openshift.io/triggers: |
      [
        {
          "from": {
            "kind": "ImageStreamTag",
            "name": "sb-demo:latest"
          },
          "fieldPath": "spec.template.spec.containers[?(@.name==\"sb-demo\")].image"
        }
      ]
    alpha.image.policy.openshift.io/resolve-names: "*"
spec:
  template:
    metadata:
      annotations:
        openshift.io/generated-by: "kustomize"
    spec:
      securityContext:
        runAsNonRoot: true
        # OpenShift assigns random UID, remove specific user
        runAsUser: null
        runAsGroup: null
        fsGroup: null
        seccompProfile:
          type: RuntimeDefault
      containers:
        - name: sb-demo
          # Use ImageStream reference for OpenShift
          image: image-registry.openshift-image-registry.svc:5000/sb-demo/sb-demo:latest
          securityContext:
            allowPrivilegeEscalation: false
            readOnlyRootFilesystem: true
            runAsNonRoot: true
            # Let OpenShift assign UID
            runAsUser: null
            runAsGroup: null
            capabilities:
              drop:
                - ALL
            seccompProfile:
              type: RuntimeDefault
          env:
            # OpenShift-specific environment variables
            - name: OPENSHIFT_BUILD_NAME
              valueFrom:
                fieldRef:
                  fieldPath: metadata.annotations['openshift.io/build.name']
            - name: OPENSHIFT_BUILD_NAMESPACE
              valueFrom:
                fieldRef:
                  fieldPath: metadata.namespace
          resources:
            requests:
              memory: "384Mi"
              cpu: "200m"
            limits:
              memory: "768Mi"
              cpu: "800m"